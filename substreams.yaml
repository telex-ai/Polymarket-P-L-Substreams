specVersion: v0.1.0
package:
  name: polymarket-pnl
  version: v1.2.0
  description: "Polymarket Profit & Loss Tracking - Real-time P&L with SQL sink support"
  url: "https://github.com/PaulieB14/Polymarket-P-L-Substreams"
  image: "./polymarket-pnl-icon.png"

imports:
  # SQL sink support
  database_change: https://github.com/streamingfast/substreams-sink-database-changes/releases/download/v4.0.0/substreams-sink-database-changes-v4.0.0.spkg
  sql: https://github.com/streamingfast/substreams-sink-sql/releases/download/protodefs-v1.0.7/substreams-sink-sql-protodefs-v1.0.7.spkg
  # Ethereum common utilities
  ethcommon: https://spkg.io/streamingfast/ethereum-common-v0.3.0.spkg

protobuf:
  files:
    - pnl.proto
  importPaths:
    - ./proto
  excludePaths:
    - sf/substreams
    - google

binaries:
  default:
    type: wasm/rust-v1
    file: ./target/wasm32-unknown-unknown/release/substreams.wasm

network: polygon

params:
  # Minimum trade size to track (USDC with 6 decimals)
  db_out: "min_trade_size=1000000"

modules:
  #############################################
  # LAYER 1: Event Extraction (Map Modules)
  #############################################

  - name: map_order_fills
    kind: map
    doc: |
      Extracts OrderFilled events from both CTF Exchange and NegRisk Exchange.
      This is the primary source of trading activity.
    initialBlock: 33605403
    blockFilter:
      module: ethcommon:index_events
      query:
        string: "(evt_addr:0x4bfb41d5b3570defd03c39a9a4d8de6bd8b8982e OR evt_addr:0xC5d563A36AE78145C45a50134d48A1215220f80a)"
    inputs:
      - source: sf.ethereum.type.v2.Block
    output:
      type: proto:pnl.v1.OrderFills

  - name: map_token_transfers
    kind: map
    doc: |
      Extracts ERC1155 TransferSingle events for position tracking.
    initialBlock: 4023686
    blockFilter:
      module: ethcommon:index_events
      query:
        string: "evt_sig:0xc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f62"
    inputs:
      - source: sf.ethereum.type.v2.Block
    output:
      type: proto:pnl.v1.TokenTransfers

  - name: map_usdc_transfers
    kind: map
    doc: |
      Extracts USDC (ERC20) transfer events for collateral tracking.
    initialBlock: 4023686
    blockFilter:
      module: ethcommon:index_events
      query:
        string: "evt_addr:0x2791bca1f2de4661ed88a30c99a7a9449aa84174"
    inputs:
      - source: sf.ethereum.type.v2.Block
    output:
      type: proto:pnl.v1.UsdcTransfers

  #############################################
  # LAYER 2: State Stores (Accumulation)
  #############################################

  - name: store_user_positions
    kind: store
    doc: |
      Accumulates user positions per token. Tracks quantity held.
      Key: {user_address}:{token_id}
      Start from Conditional Tokens deployment (4023686) for complete history.
    initialBlock: 4023686
    updatePolicy: add
    valueType: bigint
    inputs:
      - map: map_token_transfers

  - name: store_user_cost_basis
    kind: store
    doc: |
      Tracks total cost basis per user per token for average price calculation.
      Key: {user_address}:{token_id}
      Start from Conditional Tokens deployment (4023686) for complete history.
    initialBlock: 4023686
    updatePolicy: add
    valueType: bigint
    inputs:
      - map: map_order_fills

  - name: store_user_realized_pnl
    kind: store
    doc: |
      Accumulates realized P&L when users sell positions.
      Calculates: (sell_price - avg_entry_price) * sell_amount
      Key: {user_address}
      Start from Conditional Tokens deployment (4023686) for complete history.
    initialBlock: 4023686
    updatePolicy: add
    valueType: bigint
    inputs:
      - map: map_order_fills
      - store: store_user_positions
        mode: get
      - store: store_user_cost_basis
        mode: get

  - name: store_user_volume
    kind: store
    doc: |
      Tracks total trading volume per user.
      Key: {user_address}
      Start from Conditional Tokens deployment (4023686) for complete history.
    initialBlock: 4023686
    updatePolicy: add
    valueType: bigint
    inputs:
      - map: map_order_fills

  - name: store_user_trade_count
    kind: store
    doc: |
      Tracks number of trades per user.
      Key: {user_address}
      Start from Conditional Tokens deployment (4023686) for complete history.
    initialBlock: 4023686
    updatePolicy: add
    valueType: int64
    inputs:
      - map: map_order_fills

  - name: store_market_volume
    kind: store
    doc: |
      Tracks total volume per market (token_id).
      Key: {token_id}
      Start from Conditional Tokens deployment (4023686) for complete history.
    initialBlock: 4023686
    updatePolicy: add
    valueType: bigint
    inputs:
      - map: map_order_fills

  - name: store_latest_prices
    kind: store
    doc: |
      Stores latest price per token for unrealized P&L calculation.
      Key: {token_id}
      Start from Conditional Tokens deployment (4023686) for complete history.
    initialBlock: 4023686
    updatePolicy: set
    valueType: proto:pnl.v1.TokenPrice
    inputs:
      - map: map_order_fills

  #############################################
  # LAYER 3: Computed Analytics
  #############################################

  - name: map_user_pnl
    kind: map
    doc: |
      Computes real-time P&L for users based on their positions and trades.
      Outputs user P&L updates when positions change.
      Start from Conditional Tokens deployment (4023686) for complete history.
    initialBlock: 4023686
    inputs:
      - map: map_order_fills
      - store: store_user_positions
        mode: deltas
      - store: store_user_positions
        mode: get
      - store: store_user_cost_basis
        mode: get
      - store: store_user_realized_pnl
        mode: get
      - store: store_latest_prices
        mode: get
      - store: store_user_volume
        mode: get
      - store: store_user_trade_count
        mode: get
    output:
      type: proto:pnl.v1.UserPnLUpdates

  - name: map_market_stats
    kind: map
    doc: |
      Computes market-level statistics (volume, trades, prices).
      Start from Conditional Tokens deployment (4023686) for complete history.
    initialBlock: 4023686
    inputs:
      - map: map_order_fills
      - store: store_market_volume
        mode: deltas
    output:
      type: proto:pnl.v1.MarketStats

  #############################################
  # LAYER 4: SQL Sink Output
  #############################################

  - name: db_out
    kind: map
    doc: |
      Outputs database changes for SQL sink (PostgreSQL/Clickhouse).
      Creates/updates tables: trades, user_pnl, user_positions, markets
      Start from Conditional Tokens deployment (4023686) for complete history.
    initialBlock: 4023686
    inputs:
      - params: string
      - map: map_order_fills
      - map: map_user_pnl
      - map: map_market_stats
      - store: store_user_positions
        mode: deltas
      - store: store_user_cost_basis
        mode: get
      - store: store_latest_prices
        mode: get
    output:
      type: proto:sf.substreams.sink.database.v1.DatabaseChanges

sink:
  module: db_out
  type: sf.substreams.sink.sql.v1.Service
  config:
    schema: "./schema.sql"
    engine: postgres
    postgraphile_frontend:
      enabled: true
